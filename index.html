
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
    <title>Narrative Structure Analyis</title>

    <!-- Bootstrap core CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="http://hero.village.virginia.edu/~rwb3y/faulkner/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href="http://hero.village.virginia.edu/~rwb3y/faulkner/jquery-ui.css" rel="stylesheet">
    <link href="http://hero.village.virginia.edu/~rwb3y/faulkner/dropdown.css" rel="stylesheet">

<!-- Additional CSS for flexbox and plotly -->
    <link href="narrativeanalysis.css" rel="stylesheet">

  <!-- Plotly.js -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://momentjs.com/downloads/moment.js"></script>
  <script src="http://hero.village.virginia.edu/~rwb3y/faulkner/jquery.min.js"></script>
  <script src="http://hero.village.virginia.edu/~rwb3y/faulkner/jquery-ui.min.js"></script>
  <script src="http://hero.village.virginia.edu/~rwb3y/faulkner/bootstrap/js/bootstrap.min.js"></script></head>

<body>
  <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
          <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="index.html">Home</a>
          </div>
          <div class="collapse navbar-collapse">
              <ul class="nav navbar-nav">
                  <li class="dropdown active">
                      <a href="#" class="dropdown-toggle" data-toggle="dropdown">Visualizations <b class="caret"></b></a>
                      <ul class="dropdown-menu">
                          <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">Location-Character Graphs</a>
                              <ul class="dropdown-menu">
                                  <li><a href="characters-force.html">Force Directed</a></li>
                                  <li><a href="characters-bipart.html">Bipartite</a></li>
                              </ul>
                          </li>
                          <li><a href="char-char-force.html">Character-Character Graphs</a></li>
                          <li><a href="characters-graph.html">Character-Event Graphs</a></li>
                          <li class="dropdown dropdown-submenu"><a href="#" class="dropdown-toggle" data-toggle="dropdown">Heatmaps</a>
                              <ul class="dropdown-menu">
                                  <li><a href="http://faulkner.iath.virginia.edu/media/resources/DISPLAYS/HeatmapsHP.html">Spatial</a></li>
                                  <li><a href="http://faulkner.iath.virginia.edu/media/resources/DISPLAYS/TemporalHeatmapsHP.html">Temporal</a></li>
                              </ul>
                          </li>
                      </ul>
                  </li>
              </ul>
              <ul class="nav navbar-nav">
              </ul>

              <ul class="nav navbar-nav navbar-right">
                  <li class="dropdown dropdown-left ">
                      <a class="dropdown-toggle" data-toggle="dropdown" href="#">About
  		        <span class="caret"></span></a>
                      <ul class="dropdown-menu">
                          <div id="about" style="padding-left:8px;padding-right:20px">
                              <li><a href="The_Art_of_Faulkner.html">Detailed Guide</a></li>
                          </div>

                      </ul>
                  </li>
                  <li class="dropdown dropdown-left ">
                      <a class="dropdown-toggle" data-toggle="dropdown" href="#">Demo
  	        <span class="caret"></span></a>
                      <ul class="dropdown-menu">
                          <div id="demo" style="padding-left:8px;padding-right:20px">
                          </div>

                      </ul>
                  </li>
                  <li class="dropdown dropdown-left ">
                      <a class="dropdown-toggle" data-toggle="dropdown" href="#">Legend
  		        <span class="caret"></span></a>
                      <ul class="dropdown-menu">
                          <div id="legend" style="padding-left:8px">

                          </div>
                      </ul>
                  </li>
              </ul>
          </div>
      </div>
  </div>

  <div class="container">
      <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="index.html">Home</a>
      </div>
      <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
              <li class="active"><a href="#">Events</a></li>
              <li><a href="characters.html">Characters</a></li>
              <li><a href="locations.html">Locations</a></li>
              <li class=""><a href="texts.html">Career</a></li>
          </ul>
      </div>
  </div>

<div class="container-fluid">
<div class="col-md-2">
	<form id="search">
    <div class = "form-row">
      <p>Select Text:</p>
		  </div>
      <div id= addChart></div>
      <div class = "form-row">
        <button id= "btnAddChart" type="button" class="btn btn-primary" onclick= "addChartSelect()">Add Chart</button>
     </div>
     <hr>
     <div class="form-row">
     	<div id="collapse" style="display:none">
         <p><span><b>Overview:</b> The charts map the order of events (story/fabula) versus the page numbers (plot/syuzhet).</span></p>
         <p><span><b>Rank Order:</b> The order of events from first to last. Does not show the relative distance between events based on time.</span>
         <span><p style= "padding-left: 5px"><i>Narrative Status:</i> Indicates how the event was conveyed.</p></span></p>
         <p><span><b>Date Order:</b> The order of events weighted by date. Shows the difference in time between events.</span>
         <span><p style= "padding-left: 5px"><i>Date Range:</i> The earliest and latest possible date when an event could have happened.</p></span></p>
         <p><span><b>Narrative Information: </b> Detailed overview of the narrative structure of the text.</span></p>
         <p><span>For more information see <a href="The_Art_of_Faulkner.html">Detailed Guide.</a></span></p>
       </div><a href="#collapse" id="help" class="nav-toggle">Help</a>
         </div>

  </form>

 </div>


<!-- <div class= "container"> -->
<div class="col-md-10">
<div class="container">
<div>
  <center>
		<h3>Narrative Structure Analysis</h3>
	</center>
</div>
</div>
<div class = chartArea>
    <div class = flex-box id= "plotAreaFlexbox"></div>
</div>

<div class="modal fade" id="narrativeModal" role="dialog">
 <div class="modal-dialog modal-xl">
        <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Narrative Information: <span id=text_title></span></h4>
        </div>
        <div class ="modal-body">
          <div id ="NarrativeInformation">
            <div class="row">
                   <div class="column">
				                 <h4>Event Frequency</h4>
				                     <p>Total Number of Pages:<span class="narrative-info-box-number" id="total_pages"></span></p>
				                     <p>Total Number of Events:<span class="narrative-info-box-number" id="total_events"></span></p>
				                     <p>Average Number of Events:<span class="narrative-info-box-number" id="average_events"></span></p>
			             </div>
			             <div class="column">
				                 <h4>Narrative Changes</h4>
				                     <h5>Chronological Changes</h5>
				                         <p>Non-chronological jumps forward:<span class="narrative-info-box-number" id="analepsis"></span></p>
				                         <p>Non-chronological jumps backwards:<span class="narrative-info-box-number" id="prolepsis"></span></p>
				                         <p>Total Number of Temporal Changes:<span class="narrative-info-box-number" id="temp_changes"></span></p>
				                         <p>Average Temporal Change per Page:<span class="narrative-info-box-number" id="avg_temp_changes"></span></p>
					                       <h5>Change in Narrative Status</h5>
                                 <p>Total Narrative Status Changes:<span class="narrative-info-box-number" id="nar_changes"></span></p>
					                       <p>Average Narrative Status Changes per Page:<span class="narrative-info-box-number" id="avg_nar_changes"></span></p>
                  </div>
				          <div class="column">
					               <h4>Temporal Analysis</h4>
					               <h5>Significant Dates</h5>
					               <p>Earliest Date:<span class="narrative-info-box-number" id="early_date"></span></p>
                         <p>Latest Dates:<span class="narrative-info-box-number" id="late_date"></span></p>
                         <p>Total shift in time: <span class="narrative-info-box-number" id="total_change"></span></p>
                         <p>Largest shift in time between events:<span class="narrative-info-box-number" id="largest_changes"></span></p>
                         <p>Most Frequent Start Date:<span class="narrative-info-box-number" id="freq_date"></span></p>
                         <p>Most Frequent End Date:<span class="narrative-info-box-number" id="freq_end_date"></span></p>
                              </div>
                          </div>
        		</div>
        </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>


<!-- Modals -->




<script>


//Stores the titles for the selection box after AJAX request for quick use later.
var texttitles = {};
//global counters for the "add chart button". By default this is set to 0 to 3,
//generating four possible charts
addButtonCounter = 0;
const maxChartCount = 4;

//This function GETs texttitles from server and loads them into the selection
//box. It also loads the addChartSelect function which initiates all other functions.
function loadTexttitles() {
 $.ajax(
  {
   type: 'GET',
   url: 'http://hero.village.virginia.edu/sinatra/texts',
   success: function (data) {
     texttitles=data;
   addChartSelect();
    }
  })};


//adds a new panel for a chart to the input form.



function addChartSelect() {

              var oldChart = addButtonCounter;
              addButtonCounter = addButtonCounter+1;
              var newChart = addButtonCounter;

              addSelectionPanel(newChart);
              addChartPanel(newChart);
              show_graph('RE', newChart);
              refreshLayout (newChart);
          };

      function refreshLayout(previousChart){
            var i = previousChart
            var restyleChart = document.getElementById('quadrant'+(previousChart-1))
            var restyleLayout = restyleChart.layout;
            var restyleData = restyleChart.data;
            Plotly.newPlot(restyleChart, restyleData, restyleLayout)
          }

      function addChartPanel(newChart){
            var i = newChart
            var newPanel = document.createElement("DIV");
            newPanel.id = "newPanel" +i;

            var newLoading = document.createElement("DIV")
            newLoading.id = "loading"+i;
            newLoading.className = "loading";

            var newQuadrant = document.createElement("DIV")
            newQuadrant.id = "quadrant"+i;
            newQuadrant.className = "chart";

            var btnNarrativeModal = document.createElement("INPUT")
            btnNarrativeModal.id= "btnNarrativeModal"+i;
            btnNarrativeModal.type = "button"
            btnNarrativeModal.value = "Narrative Information"
            btnNarrativeModal.className = "btn btn-default";
            btnNarrativeModal.style.float = "left";

            newPanel.appendChild(newLoading);
            newPanel.appendChild(newQuadrant);
            newPanel.appendChild(btnNarrativeModal);

            var newChartPanel = document.getElementById("plotAreaFlexbox");
            newChartPanel.appendChild(newPanel);
          }

function addSelectionPanel (newChart){
  var i = newChart

        if (i >= maxChartCount) {
          document.getElementById("btnAddChart").disabled = true;
        }

var addChart = document.getElementById("addChart")

var newSelectPanel = document.createElement("ROW");
  newSelectPanel.style.border = "none";
  newSelectPanel.name= "inputNode" +i;
  newSelectPanel.className = "form-row";
  newSelectPanel.style.padding= "0px";

var inputSelectionBox = document.createElement("DIV")
  inputSelectionBox.id="select_text_titles"+i;

var btnRankOrder = document.createElement("INPUT");
  btnRankOrder.type = "button";
  btnRankOrder.value = "Rank Order";
  btnRankOrder.title = "Rank Order: Ranks events from earliest to last and ignores date.";
  btnRankOrder.id = "btnRankOrder"+i;
  btnRankOrder.className = "btn btn-primary";

var btnDateOrder = document.createElement("INPUT")
  btnDateOrder.type = "button";
  btnDateOrder.value = "Date Order";
  btnDateOrder.title = "DateOrder: Orders events by date."
  btnDateOrder.id = "btnDateOrder"+i;
  btnDateOrder.className = "btn btn-primary";

var btnRemove = document.createElement("INPUT");
  btnRemove.value = "X";
  btnRemove.type = "button";
  btnRemove.name = "btnRemove" + i;
  btnRemove.id = "btnRemove" + i;
  btnRemove.className = "btn btn-danger";
  if (i >= 2) {
      var btnRemovePrevious = "btnRemove" + (i - 1);
      var btnRemovePreviousToggle = document.getElementById(btnRemovePrevious);
      $(btnRemovePreviousToggle).hide();
  }
  btnRemove.onclick = function() {
      addChart.removeChild(this.parentNode);
      var removeChartPanel = document.getElementById("newPanel" + i)
      var addChartPanel = document.getElementById("plotAreaFlexbox");
      addChartPanel.removeChild(removeChartPanel)

      refreshLayout(i);

      if (i > 0) {
          var btnRemovePrevious = "btnRemove" + (i - 1);
          var btnRemovePreviousToggle = document.getElementById(btnRemovePrevious);
          $(btnRemovePreviousToggle).show();
      }

      var hideChart = document.getElementById("quadrant" + i)
      addButtonCounter = addButtonCounter - 1;

      if (addButtonCounter < maxChartCount) {
          document.getElementById("btnAddChart").disabled = false;
      }
  };


newSelectPanel.appendChild(inputSelectionBox);
newSelectPanel.appendChild(btnRankOrder);
newSelectPanel.appendChild(btnDateOrder);
if (i>1){
    newSelectPanel.appendChild(btnRemove);
}
addChart.appendChild(newSelectPanel);
addTitles(texttitles, newChart)
}

  function addTitles(texttitles, newChart) {
    //sets the variables for input
    var i = newChart
    var str = '<select class="form-control" name="text" id="text'+i+'">';
    var addSelectText = '#select_text_titles'+i
    //populates the input box with field codes and values
    $.each(texttitles, function(index, value) {
      texttitles[value['code']] = {'title' : value['title']};

      if (value['title'] != null) {
        var selected='';
        if (value['code'] == 'RE') {
          selected = ' selected ';
        }
        str += '<option value="'+value['code']+'"'+selected+'>'+value['title'].substr(0, 40)+ ' ('+value['publication_date'].substr(0,4)+')'+'</option>';
      }
    });
    $(addSelectText).append(str+'</select>');
};



function findEarliestDate(dates){
    if(dates.length == 0) return null;
    var earliestDate = dates[0];
    for(var i = 1; i < dates.length ; i++){
        var currentDate = dates[i];
        if(currentDate < earliestDate){
            earliestDate = currentDate;
        }
    }
    return earliestDate;
}


function findLastDate(dates){
    if(dates.length == 0) return null;
    var lastDate = dates[0];
    for(var i = 1; i < dates.length ; i++){
        var currentDate = dates[i];
        if(currentDate > lastDate){
          lastDate = currentDate;
        }
    }
    return lastDate;
}


function get_rankorder (RankArray) {
                    var ranksort = RankArray.slice().sort(function(a,b){return a-b});
                    RankArray  = RankArray.slice().map(function(v){return (ranksort.indexOf(v)+1)});
                    return RankArray
  }


function loadAnalytics(tempdata) {

var rankorder =[]; //variable gets chronological values and reorders them by rank as integers
var page_count=[];
var narrative_stat=[]; //used to determine the switches in narrative status.
var begin_date=[]; //used for configuring the seconday Y axis and discovering date information.
var end_date=[];

texttitle = tempdata[0].event_source_title;
$('#text_title').text(texttitle);

for (let key in tempdata){
    rankorder.push(tempdata[key].chronological);
    page_count.push(tempdata[key].page_number_int);
    narrative_stat.push(tempdata[key].naerrative_status);
    begin_date.push(tempdata[key].event_begin);
    end_date.push(tempdata[key].event_end);
}

rankorder = get_rankorder(rankorder);

//This section creates the data for the Narrative Analysis
var totalpages = (page_count[page_count.length-2]-page_count[0])+1;
var totalevents = rankorder.length-1;
var average_events = (rankorder.length-1)/(totalpages);
average_events = Number((average_events).toFixed(2));

$('#total_pages').text(totalpages);
$('#total_events').text(totalevents);
$('#average_events').text(average_events);

//Measure the amount of flashbacks and flashforwards
var flashback =0;
var flashforward =0;

for (i = 0; i < rankorder.length; i++) {
  if ((rankorder[i] - rankorder[i+1]) > -1){
        flashforward= flashforward+1
    }
    if ((rankorder[i] - rankorder[i+1]) < -1){
          flashback=flashback+1
      }
    }

var total_temp = flashforward + flashback;
var average_temp = Number((total_temp/totalpages).toFixed(2));

$('#analepsis').text(flashback);
$('#prolepsis').text(flashforward);
$('#temp_changes').text(total_temp);
$('#avg_temp_changes').text(average_temp);

var stat_change = 0;

for (i = 0; i < narrative_stat.length; i++) {
  if (narrative_stat[i] !== narrative_stat[i+1])
    {
      stat_change++
    }
}

$('#nar_changes').text(stat_change);
$('#avg_nar_changes').text(Number((stat_change/totalpages).toFixed(2)));


//Measure the dates

begin_date= begin_date.map(date => moment(date, "YYYY-MM-DD"))

var early_date = findEarliestDate(begin_date)
early_date = moment(early_date).format('MM-DD-YYYY');

end_date = end_date.map(date => moment(date, "YYYY-MM-DD"))

var late_date = findLastDate(end_date)
late_date = moment(late_date).format('MM-DD-YYYY')

var total_time_dif = moment(late_date).diff(moment(early_date), 'years');
var totalPeriod= 'years'
if (total_time_dif<2){
total_time_dif= moment(late_date).diff(moment(early_date), 'months')
totalPeriod='months'
}
if (total_time_dif<=1){
total_time_dif=moment(late_date).diff(moment(early_date), 'days')
totalPeriod='days'
}

console.log(total_time_dif)
var freq_start_date = mode(begin_date)
freq_start_date = moment(freq_start_date).format('MM-DD-YYYY')

var freq_end_date = mode(end_date)
freq_end_date = moment(freq_end_date).format('MM-DD-YYYY')



function mode(array)
{
    if(array.length == 0)
        return null;
    var modeMap = {};
    var maxEl = array[0], maxCount = 1;
    for(var i = 0; i < array.length; i++)
    {
        var el = array[i];
        if(modeMap[el] == null)
            modeMap[el] = 1;
        else
            modeMap[el]++;
        if(modeMap[el] > maxCount)
        {
            maxEl = el;
            maxCount = modeMap[el];
        }
    }
    return maxEl;
}

var minimum = 0;
var period = "years";
var humanDate ='';

     for(i = 1; i  <  (begin_date.length - 1); i++){
        var temp = begin_date[i+1].diff(begin_date[i], 'years');
        if (temp  >= minimum)
           minimum = temp;
            }

           if (minimum<2){
            for(i = 1; i  <  (begin_date.length - 1); i++){
             var temp = begin_date[i+1].diff(begin_date[i], 'months');
             if (temp  >= minimum)
                minimum = temp;
              }
              period = "months"
                    }

                    if (minimum<1){
                     for(i = 1; i  <  (begin_date.length - 1); i++){
                      var temp = begin_date[i+1].diff(begin_date[i], 'days');
                      if (temp  >= minimum)
                         minimum = temp;
                       }
                       period = "days"
                             }


$('#total_change').text("Around "+ total_time_dif+" "+totalPeriod)
$('#largest_changes').text("Around "+minimum +" "+ period)
$('#freq_date').text(freq_start_date)
$('#freq_end_date').text(freq_end_date)
$('#early_date').text(early_date)
$('#late_date').text(late_date)

}




  function show_graph(text, chartCounter) {

    var currentChart = chartCounter
    var loading = '#loading'+currentChart
    const quadrant = 'quadrant'+currentChart
    var btnRankOrder = '#btnRankOrder'+currentChart
    var btnDateOrder = '#btnDateOrder'+currentChart
    var loadText = '#text'+currentChart
    var btnNarrativeModal ='#btnNarrativeModal'+currentChart



    var loadedChart = document.getElementById(quadrant)
$(loadedChart).hide();
$(loading).show();


    	  	$.ajax({
          xhr: function() {

                  $(loading).text('Fetching data...');
                  var xhr = new window.XMLHttpRequest();
                 // Download progress
                 xhr.addEventListener("progress", function(evt){
                     if (evt.lengthComputable) {
                         var percentComplete = (evt.loaded / evt.total)*100;
                        $(loading).text('Loading: '+Number((percentComplete).toFixed(0))+'%');
                     }
                 }, false);
                 return xhr;
              },

          type: 'GET',
  			  url: 'http://hero.village.virginia.edu/sinatra/?text='+text, //+'&params='+encodeURIComponent(JSON.stringify(e)),
          dataType:'json',
          cache:true,
  	      success: function (data) {

          var nx = [];
  			  var ny= [];
  			  var nx1 = [];
  			  var ny1= [];
  			  var ntext = [];
  			  var ns = [];
  			  var ncx = [];
  			  var ncy= [];
  			  var nctext = [];
  			  var ncs = [];
  			  var rx = [];
  			  var ry = [];
  			  var rtext = [];
  			  var rs = [];
  			  var tx = [];
  			  var ty= [];
  			  var ttext = [];
  			  var ts = [];
          var hx = [];
  			  var hy = [];
  			  var htext = [];
  			  var hs = [];
          var era = {};


        //horizontal line segments
  			  var hz_lines_x = [];
  			  var hz_lines_y = [];
  			  var hz_lines_style = [];
          var hz_lines_name = [];

          //secondary y axis
            var ny2_low = [];
            var ny2_high = [];
            var ny2_low_text = [];
            var ny2_high_text = [];


          var texttitle = [];
          texttitle = data.results[0].event_source_title;
          var firstpage = data.results[0].page_number_int;


          //Reranking data

          var tempdata = data.results;


          var rankorder =[]; //variable gets chronological values and reorders them by rank as integers
          var page_count=[];
          var narrative_stat=[]; //used to determine the switches in narrative status.
          var begin_date=[]; //used for configuring the seconday Y axis and discovering date information.
          var end_date=[];


  for (let key in tempdata){
            ny2_low.push(tempdata[key].event_begin);
            ny2_high.push(tempdata[key].event_end);
            ny2_low_text.push("Page and Event: " +tempdata[key].order_in_p+"<br>" + "Earliest Date: " + tempdata[key].event_begin + "<br>" + "First Words: " +tempdata[key].first_words);
            ny2_high_text.push("Page and Event: " +tempdata[key].order_in_p+"<br>" + "Latest Date: " + tempdata[key].event_end + "<br>" + "First Words: " +tempdata[key].first_words);
                  }

for (let key in tempdata){
rankorder.push(tempdata[key].chronological);
}

  //Define Rankorder


  //Define Rankorder
  rankorder = get_rankorder(rankorder);
  //Fill Rankorder in Array
  for (let key in data.results){
        data.results[key].rank = rankorder[key];
                  }




  	$.each(data["results"], function(index, value) {

          if (value['naerrative_status'] == 'Narrated') {
            //This generates the stylings for the markers.
            var textstring = "Page and Event Number: "+value['order_in_p']+"</br>"+"Event Order: "+value['rank']+"<br>"+"First Words: "+value['first_words']
            ntext.push(textstring)
            ntext.push(textstring)
            ns.push('circle');
            ns.push('circle-open');

            //Add ranks to the Y axis
  			    ny1.push(value['rank']);
  				  ny1.push(value['rank']);
            //Add ranks to the x axis based on value. If the value stretches across
            //multiple pages it sets it to page end. Otherwise it sets it to the page order.
  				  nx1.push(value['order_in_p']);
            if(parseInt(value['page_end']) > parseInt(value['order_in_p'])) {
  					  nx1.push(value['page_end']);
  				  } else {
  				  	nx1.push(value['order_in_p']);
  				  }
  				  //This sets the horizonal lines.
            if (parseInt(value['page_end']) > parseInt(value['order_in_p'])) {
  					    hz_lines_x.push([value['order_in_p'],value['page_end']]);
  					    hz_lines_y.push([value['rank'], value['rank']]);
  					    hz_lines_style.push([textstring, 'Orange']);
                hz_lines_name.push('Narrated');
  			      }
        }
  			  if (value['naerrative_status'] == 'Narrated+Consciousness') {
            //Styling and text
            var textstring = "Page and Event Number: "+value['order_in_p']+"</br>"+"Event Order: "+value['rank']+"<br>"+"First Words: "+value['first_words']
            nctext.push(textstring);
            nctext.push(textstring);
            ncs.push('circle');
            ncs.push('circle-open');

            //Y markers
            ncy.push(value['rank']);
            ncy.push(value['rank']);
            // X Markers
            ncx.push(value['order_in_p']);
            if(parseInt(value['page_end']) > parseInt(value['order_in_p'])) {
              ncx.push(value['page_end']);
            } else {
              ncx.push(value['order_in_p']);
            }
            //Horizontal lines
            if (parseInt(value['page_end']) > parseInt(value['order_in_p'])) {
                hz_lines_x.push([value['order_in_p'],value['page_end']]);
                hz_lines_y.push([value['rank'], value['rank']]);
                hz_lines_style.push([textstring, 'Violet']);
                hz_lines_name.push('Narrated+Consciousness');
            }
  		  }
  			  if (value['naerrative_status'] == 'Remembered') {
            //Styling
            var textstring = "Page and Event Number: "+value['order_in_p']+"</br>"+"Event Order: "+value['rank']+"<br>"+"First Words: "+value['first_words']
            rtext.push(textstring);
            rtext.push(textstring);
            rs.push('circle');
            rs.push('circle-open');

            //Y markers
            ry.push(value['rank']);
            ry.push(value['rank']);
            //X Markers
            rx.push(value['order_in_p']);
            if(parseInt(value['page_end']) > parseInt(value['order_in_p'])) {
              rx.push(value['page_end']);
            } else {
              rx.push(value['order_in_p']);
            }
            //Horizontal lines
            if (parseInt(value['page_end']) > parseInt(value['order_in_p'])) {
                hz_lines_x.push([value['order_in_p'],value['page_end']]);
                hz_lines_y.push([value['rank'], value['rank']]);
                hz_lines_style.push([textstring, 'DodgerBlue']);
                hz_lines_name.push('Remembered');
            }

  			  }

          if (value['naerrative_status'] == 'Told') {
            //Styling
            var textstring = "Page and Event Number: "+value['order_in_p']+"</br>"+"Event Order: "+value['rank']+"<br>"+"First Words: "+value['first_words']
            ttext.push(textstring);
            ttext.push(textstring);
            ts.push('circle');
            ts.push('circle-open');

            //Y markers
            ty.push(value['rank']);
            ty.push(value['rank']);
            //X Markers
            tx.push(value['order_in_p']);
            if(parseInt(value['page_end']) > parseInt(value['order_in_p'])) {
              tx.push(value['page_end']);
            } else {
              tx.push(value['order_in_p']);
            }
            //Horizontal Lines
            if (parseInt(value['page_end']) > parseInt(value['order_in_p'])) {
                hz_lines_x.push([value['order_in_p'],value['page_end']]);
                hz_lines_y.push([value['rank'], value['rank']]);
                hz_lines_style.push([textstring, 'MediumSeaGreen']);
                hz_lines_name.push('Told');
              }

  			  }

          if (value['naerrative_status'] == 'Hypothesized') {
            //Styling
            var textstring = "Page and Event Number: "+value['order_in_p']+"</br>"+"Event Order: "+value['rank']+"<br>"+"First Words: "+value['first_words']
            htext.push(textstring);
            htext.push(textstring);
            hs.push('circle');
            hs.push('circle-open');

            //Y Markers
            hy.push(value['rank']);
            hy.push(value['rank']);
            //X Markers
            hx.push(value['order_in_p']);
            if(parseInt(value['page_end']) > parseInt(value['order_in_p'])) {
               hx.push(value['page_end']);
            } else {
               hx.push(value['order_in_p']);
            }
           //Horizontal Lines
            if (parseInt(value['page_end']) > parseInt(value['order_in_p'])) {
                hz_lines_x.push([value['order_in_p'],value['page_end']]);
                hz_lines_y.push([value['rank'], value['rank']]);
                hz_lines_style.push([textstring, 'Tomato']);
                hz_lines_name.push('Hypothesized');
              }
          }
  		});



  //Date Traces


  var datelegendtitle = {
        x:nx1,
        y:ny2_low,
        name:'<b>Date Range</b>',
        line:{'color': 'rgba(0, 0, 0, 0)'},
      }


var narrated_date_begin = {
        x: nx1,
        y: ny2_low,
        hoverinfo:'text',
        type:'scatter',
        mode:'lines+markers',
        text: ny2_low_text,
        line: {color: 'DodgerBlue', size:1, dash: "dot"},
        name:'Earliest Date',
      }
var narrated_date_end = {
        x: nx1,
        y:ny2_high,
        text: ny2_high_text,
        hoverinfo:'text',
        type:'scatter',
        mode:'lines+markers',
        name:'Latest Date',
          line: {color: 'Tomato', size:1, dash:"dot" }
      }

      //This is a workaround to create a legend for narrative status.
        var ranklegendtitle = {
              x:nx1,
              y:ny1,
              name:'<b>Narrative Status</b>',
              marker:{'color': 'rgba(0, 0, 0, 0)'},
            }


var narrated_consciousness = {
  				x: ncx,
  				y: ncy,
  				mode: 'markers',
  				name: 'Narrated+Consciousness',
          legendgroup: 'Narrated+Consciousness',
          hoverinfo:'text',
  				text: nctext,
  			    marker: { color: 'Violet', size: 7, symbol: ncs }
  			}



var narrated = {

  				x: nx1,
  				y: ny1,
          mode: 'markers',
  				name: 'Narrated',
          legendgroup: 'Narrated',
  				text: ntext,
          hoverinfo:'text',
  			    marker: { color: 'Orange', size: 7, symbol: ns },

  			}
var remembered = {
  				x: rx,
  				y: ry,
  				mode: 'markers',
  				name: 'Remembered',
          legendgroup: 'Remembered',
          hoverinfo:'text',
          text: rtext,
  			    marker: { color: 'DodgerBlue', size: 7, symbol: rs }
  			}
var told = {
  				x: tx,
  				y: ty,
  				mode: 'markers',
  				name: 'Told',
          legendgroup: 'Told',
          hoverinfo:'text',
          text: ttext,
  			    marker: { color: 'MediumSeaGreen', size: 7, symbol: ts }
  			}
var hypothesized = {
  				x: hx,
  				y: hy,
  				mode: 'markers',
  				name: 'Hypothesized',
          legendgroup: 'Hypothesized',
          hoverinfo:'text',
  				text: htext,
  			    marker: { color: 'Tomato', size: 7, symbol: hs }
  			}
var data = [ranklegendtitle, narrated, narrated_consciousness, remembered, told, hypothesized];
var data2 = [datelegendtitle,narrated_date_begin, narrated_date_end];

  		 $.each(hz_lines_x, function(i,v) {
  			data.push({x: hz_lines_x[i], y: hz_lines_y[i], mode: 'lines', text: hz_lines_style[i][0], name: hz_lines_name[i], legendgroup: hz_lines_name[i], hoverinfo:'text', line: {
  		  		color: hz_lines_style[i][1], width: 2}, showlegend: false});
  		  })

  			var xmax = Math.max([Math.max(nx),Math.max(ncx),Math.max(rx),Math.max(tx),Math.max(hx)]);
  			var ymax = Math.max([Math.max(ny),Math.max(ncy),Math.max(ry),Math.max(ty),Math.max(hy)]);

  	  	  var layout = {
  	  	    xaxis: {
  	  	      range: [0, xmax],
  				    title: 'Page Number of Event',
              },
  	  	    yaxis: {
              range: [0, ymax],
              title: 'Chronological Rank of Event',
  	  	      },

  	  	    title: texttitle,
            plot_bgcolor: 'rgb(252, 252, 252)',
  			       hovermode: 'closest',
            autosize: true,
          };
          var layout2 = {
            xaxis: {
              range: [0, xmax],
              title: 'Page Number of Event',
              },
            yaxis: {
              title: 'Date of Event',
              autosize:true,
              },

            title: texttitle,
            plot_bgcolor: 'rgba(252, 252, 252, .5)',
               hovermode: 'closest'
          };
          var config = {
            responsive:true,
            toImageButtonOptions: {
              format: 'png', // one of png, svg, jpeg, webp
              filename: 'DY_narrative analysis '+texttitle+" (Rank Order)",
            },
            displaylogo:false,
          };
          var config2 = {
            responsive:true,
            toImageButtonOptions: {
              format: 'png', // one of png, svg, jpeg, webp
              filename: 'DY_narrative analysis '+texttitle+" (Date Order)",
            },
            displaylogo:false,
          };

          $(loading).hide();
          $(loadedChart).show();

          Plotly.newPlot(quadrant, data, layout, config);

          $(document).on('click',btnRankOrder, function(){

          Plotly.newPlot(quadrant, data, layout, config);
          })

          $(document).on('click',btnDateOrder, function(){
            Plotly.newPlot(quadrant, data2, layout2, config2);
           })

          $(document).on('change', loadText, function(){
           show_graph($(this).val(), currentChart);
            })

            $(document).on('click',btnNarrativeModal, function(){
              loadAnalytics(tempdata)
              $("#narrativeModal").modal()
            })
        }
  	  })
}


///
  $(function() {
    // Handler for .ready() called.
    loadTexttitles();
  });

  $(document).ready(function () {
    $('.nav-toggle').click(function () {
        var collapse_content_selector = $(this).attr('href');
        var toggle_switch = $(this);
        $(collapse_content_selector).toggle(function () {
            if ($(this).css('display') == 'none') {
                toggle_switch.html('Help');
            } else {
                toggle_switch.html('Close help');
            }
        });
    });

});

  </script>
</body>
